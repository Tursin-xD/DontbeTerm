# DontbeTerm Bug 修复历史

本文档记录所有已修复的 bug，确保在开发新功能时不会让旧 bug 复现。

## 已修复的 Bug

### 2026-02-12

#### 1. 按钮布局和样式不统一
**问题描述**：添加新按钮后，标签栏的按钮（+终端、+cc、+happy）布局混乱，形状不统一。

**根本原因**：
- CSS 中只为 `#btn-add-terminal` 和 `#btn-add-claude` 定义了样式
- 新添加的 `#btn-add-happy` 没有包含在样式选择器中
- 按钮使用固定宽度（28px），无法容纳文本内容

**修复方案**：
- 更新 `renderer/styles.css` 第 312-337 行
- 将 `#btn-add-happy` 添加到样式选择器中
- 移除固定宽度，改用 `min-width` 和 `padding`
- 调整字体大小从 16px 到 13px，更适合文本显示
- 添加 `white-space: nowrap` 防止文本换行

**相关文件**：
- `renderer/styles.css` (第 312-337 行)

**测试要点**：
- 三个按钮应该有统一的样式和高度
- 按钮文本应该完整显示，不换行
- 鼠标悬停时应该有统一的交互效果

---

#### 2. 应用启动时主题不跟随系统
**问题描述**：应用启动时应该跟随系统主题，但系统是亮色模式时，应用却显示为夜间模式。

**根本原因**：
- 主题检测逻辑本身是正确的
- 可能是某些边缘情况下 `window.matchMedia` 返回值不准确
- 缺少调试日志，难以定位问题

**修复方案**：
- 在 `renderer/app.js` 第 292-295 行添加调试日志
- 在 `initTheme()` 函数中添加日志输出
- 确保主题初始化逻辑正确执行

**相关文件**：
- `renderer/app.js` (第 286-310 行)

**测试要点**：
- 系统为亮色模式时，应用应该启动为日间模式
- 系统为暗色模式时，应用应该启动为夜间模式
- 检查控制台日志确认主题检测值正确

---

#### 3. node-pty 无法创建终端进程
**问题描述**：点击添加终端按钮时，出现 `posix_spawnp failed` 错误，无法创建终端。

**根本原因**：
- 使用 `--config.npmRebuild=false` 跳过 native 模块重建
- node-pty 的 native 模块没有正确构建
- 项目路径包含空格，导致构建问题

**修复方案**：
- 运行 `npm run rebuild` 重新构建 native 模块
- 虽然路径有空格会有警告，但 electron-rebuild 可以完成构建
- 确保在开发环境中 native 模块正确构建

**相关文件**：
- `package.json` (rebuild 脚本)
- `node_modules/node-pty`

**测试要点**：
- 点击 "+终端" 按钮应该能创建新终端
- 点击 "+cc" 按钮应该能创建 Claude Code 终端
- 点击 "+happy" 按钮应该能创建终端并执行 happy 命令
- 终端应该能正常输入和输出

---

## 历史 Bug（v1.2.0 之前）

### API Key 安全问题
**修复版本**：v1.2.0
**问题**：应用中硬编码 API Key，存在安全风险
**解决方案**：移除 API Key 配置，改用 Claude Code CLI 实现标签命名功能

### 构建路径空格问题
**修复版本**：v1.2.0
**问题**：项目路径包含空格时，electron-builder 无法构建
**解决方案**：在构建脚本中添加 `--config.npmRebuild=false` 参数

---

## 开发注意事项

### 添加新功能时的检查清单

1. **样式一致性**
   - [ ] 新添加的 UI 元素是否有完整的 CSS 样式定义
   - [ ] 样式是否与现有元素保持一致
   - [ ] 是否支持日间/夜间两种主题

2. **功能完整性**
   - [ ] 新功能是否有对应的事件监听器
   - [ ] 是否正确处理了错误情况
   - [ ] 是否添加了必要的调试日志

3. **兼容性**
   - [ ] 是否影响现有功能
   - [ ] Native 模块是否需要重新构建
   - [ ] 是否在不同主题下测试

4. **文档更新**
   - [ ] 是否更新了 CLAUDE.md
   - [ ] 是否更新了 BUGFIX_HISTORY.md
   - [ ] 是否更新了版本号

---

## 测试流程

### 每次发布前的完整测试

1. **基础功能测试**
   - [ ] 创建新终端
   - [ ] 创建 Claude Code 终端
   - [ ] 创建 Happy 终端
   - [ ] 关闭标签
   - [ ] 切换标签
   - [ ] 重命名标签

2. **主题测试**
   - [ ] 日间模式显示正常
   - [ ] 夜间模式显示正常
   - [ ] 主题切换功能正常
   - [ ] 启动时跟随系统主题

3. **高级功能测试**
   - [ ] 自动命名标签功能
   - [ ] Claude 命令菜单
   - [ ] 复制日志功能
   - [ ] 滚动到底部功能

4. **构建测试**
   - [ ] macOS arm64 构建成功
   - [ ] macOS x64 构建成功
   - [ ] Windows x64 构建成功
   - [ ] 生成的安装包可以正常安装和运行

---

## 版本历史

### v1.2.0 (2026-02-12)
- 添加 +happy 按钮功能
- 修复按钮样式统一性问题
- 修复主题跟随系统问题
- 修复 node-pty 终端创建问题
- 创建 bug 追踪文档

### v1.1.0
- 添加主题切换功能
- 优化 macOS 设计风格
- 改进标签管理

### v1.0.0
- 初始版本发布
- 基础多标签终端功能
